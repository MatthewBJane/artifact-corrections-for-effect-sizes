# Indirect Selection

```{r color_scheme,echo = F,warning=F,message=F}

library(raster)
library(metR)
library(isoband)
library(latex2exp)
library(extrafont)
library(ggplot2)
library(ggExtra)
library(patchwork)
library(ggdist)
library(psychmeta)
library(MASS)

numform <- function(val) { sub("^(-?)0.", "\\1.", sprintf("%.2f", val)) }
numformSE <- function(val) { sub("^(-?)0.", "\\1.", sprintf("%.3f", val)) }
numform0 <- function(val) { sprintf("%.2f", val) }
numform0SE <- function(val) { sprintf("%.3f", val) }


text_color_blue      = '#326982ff'
panel_color_blue     = '#f6fafbff'
lightmain_color_blue = '#a4cdd9ff'
main_color_blue      = '#5fa6bcff'
darkmain_color_blue  = '#397689ff'
border_color_blue    = '#5fa6bcff'

text_color_red       = '#a62675ff'
panel_color_red      = '#fdf6faff'
lightmain_color_red  = '#eeb4d7ff'
main_color_red       = '#d74ea2ff'
darkmain_color_red   = '#bf2986ff'
border_color_red     = '#d74ea2ff'

group_color_red = '#e383be'
group_color_blue = '#4c8596'


th_blue <- theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.title = element_text(color = text_color_blue),
        panel.background = element_rect(fill = panel_color_blue),
        panel.border = element_rect(fill = NA, color = border_color_blue,linewidth=1.2),
        axis.title = element_text(size=15, color = text_color_blue),
        axis.text.x = element_text(size=13, color = text_color_blue),
        axis.text.y = element_text(size=13, color = text_color_blue),
        axis.ticks = element_line(color = border_color_blue,linewidth=1)) 
  
th_red <- theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.title = element_text(color = text_color_red),
        panel.background = element_rect(fill = panel_color_red),
        panel.border = element_rect(fill = NA, color = border_color_red,linewidth=1.2),
        axis.title = element_text(size=15, color = text_color_red),
        axis.text.x = element_text(size=13, color = text_color_red),
        axis.text.y = element_text(size=13, color = text_color_red),
        axis.ticks = element_line(color = border_color_red,linewidth=1)) 
```

## Introduction

Indirect selection occurs when the selection process is not directly on the variable of interest, but rather on another related variable. Similar to direct range restriction, this will cause restriction (or enhancement) in the variable of interest.

## An Example of Indirect Range Restriction

Imagine a research team is conducting a study on academic motivation among college students using a survey that includes various questions related to academic engagement, goal orientation, and effort investment. The researchers administer the survey to a large sample of students across different universities. However, during the data cleaning process, the researchers identify a subset of respondents who exhibited signs of inattentiveness and carelessness in their responses. These signs include straight-lining questions (e.g., consistently selecting the same response option without reading the questions) or responding randomly without considering the content of the questions. Recognizing that inattentive or careless responding can distort the measurement of academic motivation, the researchers decide to exclude these individuals from the analysis. The rationale is to ensure that the data collected represents genuine responses and validly measures academic motivation. The unintended consequence of this decision is indirect range restriction. By removing inattentive and careless responders, who likely also have lower academic motivation and engagement, from the dataset, the observed range of academic motivation scores is reduced. The excluded individuals, who may have had lower academic motivation scores, are not accounted for in the analysis, resulting in an underestimation of the variability of academic motivation relative to the population.

## Selection Functions

In the previous chapter we introduced the concept of a selection function for direct range restriction. Here we will expand on that section for the case of indirect range restriction, where we must introduce a new variable, $Z$. Indirect selection by definition means that the variable of interest is not used in the selection process, rather, the selection directly on another variable such that, $\mathcal{S}(Z)$ (@fig-indirect-select-diag illustrates the selection process).

![Diagram illustrating the selection process. The variable, $X$, is selected based on a function of itself. Therefore the variable under selection is conditional on the selection procedure $X|\mathcal{S}(X)$.](figure/indirect_select_diagram.png){#fig-indirect-select-diag}

However, selecting on $Z$ may affect the distribution of $X$ depending on the relationship between $X$ and $Z$. Particularly, if we assume normally distributed variables the correlation between $X$ and $Z$ can entirely describe the affect that $\mathcal{S}(Z)$ has on the distribution of $X$. If $X$ and $Z$ are independent ($\rho_{XZ}=0$), then selection on $Z$ would not affect the distribution of $X$ such that,

$$
f(X|\mathcal{S}(Z)) = f(X),\;\;\;\; \rho_{XZ}= 0
$$

For example, consider that we select individual's in the top half of $Z$ (i.e., above the mean, $\mu_{Z}$), such that our selection function can be defined as,

$$\mathcal{S}(Z) = \begin{cases}1 & \text{if }Z\geq\mu_{Z}\\ 0 & \text{if }Z<\mu_{Z} \end{cases}$$ If the correlation, $\rho_{XZ}$ is positive, then the distribution of $X|\mathcal{S}(Z)$ (i.e., $X$ given selection on $Z$) will have a higher mean and less variability (see @fig-indirect-select-diag)

![Diagram illustrating the impact of selecting on $Z$ has on $X$ given a positive correlation. The selection function on the top of the plot denotes what values of $Z$ are selected (i.e., $\mathcal{S}(Z)$). The distributions on the right indicate the distribution of $X$ (in black) and the distribution $X$ after](figure/selection_function_indirect.png)

If there is no correlation between $X$ and $Z$, then the distribution of $X|\mathcal{Z}$ would be left unchanged (see @fig-indirect-select-diag-no-corr).

![Diagram illustrating the direct selection function. The variable, $X$, in the population is selected based on a function of itself. Therefore the variable under selection is conditional on the selection procedure $X|\mathcal{S}(X)$.](figure/selection_function_indirect_no_corr.png){#fig-indirect-select-diag-no-corr}

## Quantifying Selection-Induced Restriction/enhancement

The distribution of scores in the target population may exhibit a greater (or lesser) degree of variability compared to the sample that has been selected into the study. Therefore the standard deviation of scores in the target population ($\sigma_{X}$) may differ from the population under selection. ($\sigma_{X|mathcal{S}(Z)}$). To index the difference between the two standard deviations, we can calculate the $u$-ratio [@hunter1990a, @wiernik2020]. The $u$-ratio is the ratio between the standard deviations of the population under selection and the target population such that ($\upsilon$ denotes the population $u$-ratio),

$$
\upsilon_X = \frac{\sigma_{X|\mathcal{S}(Z)}}{\sigma_{X}}
$$

The $u$-ratio in cases of range *restriction* will exist in the interval (0--1). Conversely, when the $u$-ratio is greater than 1 it is indicative of range *enhancement*. The target population standard deviation is often quite difficult to acquire since we do not usually have access to a random sample from that population. However, the target population standard deviation can be estimated from a reference sample that is representative of the target population. This often comes in the form of standardization samples or norm samples (obtained from test manuals) if the unrestricted group is the general population. For example, the distribution full-scale IQ scores derived from the Wechsler Adult Intelligence Test has a standard deviation of 15 in the US population [@wechsler2008]. We can use this estimate as the standard deviation for the unrestricted population. Lets say we select a sample from members of Harvard students, who tend to have higher IQs than the general population (this is due to the fact that selection criterion, such as GPA and SAT scores are positively correlated with IQ). If the standard deviation of IQ in Harvard students is 10, then the $u$-ratio would be,

$$
u_X =  \frac{S_{X|\mathcal{S}(Z)}}{S_X} = \frac{10}{15}= .67
$$

However it is not always the case that an estimate of the unrestricted standard deviation is readily available. Therefore if the reliability coefficient from the reference sample and the sample under selection can be used to estimate the $u$-ratio,

$$
u_X = \sqrt{\frac{1-r_{XX'}}{1-r_{XX'|\mathcal{S}(Z)}}}
$$

Where $r_{XX'|\mathcal{S}(Z)}$ and $r_{XX'}$ are the reliability estimates from the sample under selection and the reference (target population) sample, respectively. In the context of indirect range restriction, the selection does not occur directly on $X$ (or $Y$), instead it occurs on a third variable, $Z$. The affect that selection on $Z$ has on $X$ is dependent on the correlation between them, $\rho_{XZ}$. Therefore we can see how the $u$-ratio of $Z$ ($u_Z$) related to the $u$-ratio of $X$,

$$
u_X = \sqrt{\rho_{XZ}^2u_Z^2 -\rho_{XZ}^2 + 1 }
$$

If $\rho_{XZ}=0$, then you will notice that $u_X=1$, effectively having no selection effect on $X$. Also, notice that a correlation of $\rho_{XZ}=1$ will return $u_X=u_Z$, indicating that selecting on $Z$ would affect the variation of $Z$ similarly to the variation in $X$. This relationship between $u_X$, $u_Z$, and $\rho_{XZ}$ can be visualized in @fig-ux-uz

```{r, echo =FALSE,message=FALSE,warning=FALSE, fig.height=8}
#| id: fig-ux-uz
#| fig-cap: The impact of the association between $X$ and $Z$. The data consists of $N=1,000$ simulated observations, where the red plots show a low correlation case ($\rho_{XZ}=.20$) and the blue plots show a high correlation case ($\rho_{XZ}=.80$). The top plots show the relationship between $X$ and $Z$ with the darker points indicating individuals that have been selected into the sample. The bottom plots shows the probability of selection into the sample as a function of X. The dark distribution on the top of the plot show the distribution of individuals in the selected sample. Notice that the distribution of the selected individual's in the high correlation case is a narrower distribution than the low correlation case.

set.seed(34444)
data <- mvrnorm(n=1000,mu=c(0,0),
                Sigma = reshape_vec2mat(c(.8)),
                empirical=TRUE)
x = data[,1]
z = data[,2]
Selected <- z > 0
Selected = ifelse(Selected, "selected", "rejected")

uz = sd(z[Selected=="selected"])
ux = sd(x[Selected=="selected"])

h1 = ggplot(data=NULL,aes(x = x))  +
  stat_dots(aes(y = as.numeric(Selected=='selected'), 
                side = ifelse(Selected == "selected", "bottom", "top"),
                alpha = Selected),
    na.rm = TRUE, scale=1/3,fill=main_color_blue,color=main_color_blue) +
  stat_smooth(aes(y = as.numeric(Selected=='selected')),
              method = 'glm', 
              method.args = list(family='binomial'),
              se = FALSE,
              color = text_color_blue) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = 'none',
        title = element_text(color = text_color_blue)) +
  scale_fill_brewer() +
  scale_alpha_manual(values = c(.1,.9)) +
  annotate(geom='text',x=-1.85,y=.76,
           label=TeX(paste0('$u_X=$',numform(ux))),color=text_color_blue) +
  annotate(geom='text',x=-1.85,y=.7,
           label=TeX(paste0('$u_Z=$',numform(uz))),color=text_color_blue) +
  th_blue +
  labs(
    x = "X",
    y = ""
  )

h1u = ggplot(data=NULL,aes(x = x,y=z))  +
  geom_point(aes(alpha = Selected),
    na.rm = TRUE, size=.8,fill=main_color_blue,color=main_color_blue) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = 'none',
        title = element_text(color = text_color_blue)) +
  scale_fill_brewer() +
  scale_x_continuous(limits = c(-3,3)) +
  scale_y_continuous(limits = c(-3,3)) +
  scale_alpha_manual(values = c(.15,.8)) +
  th_blue +
  labs(
    title = TeX('High correlation: $\\rho_{XZ}=$.80'),
    x = "X",
    y = "Z"
  )




set.seed(4)
data <- mvrnorm(n=1000,mu=c(0,0),
                Sigma = reshape_vec2mat(c(.20)),
                empirical=TRUE)
x1 = data[,1]
z1 = data[,2]
Selected1 <- z1 > 0
Selected1 = ifelse(Selected1, "selected", "rejected")

uz1 = sd(z1[Selected1=="selected"])
ux1 = sd(x1[Selected1=="selected"])

h2 = ggplot(data=NULL,aes(x = x1))  +
  stat_dots(aes(y = as.numeric(Selected1=='selected'), 
                side = ifelse(Selected1 == "selected", "bottom", "top"),
                alpha = Selected1),
    na.rm = TRUE, scale = 1/3,fill=main_color_red,color=main_color_red) +
  stat_smooth(aes(y = as.numeric(Selected1=='selected')),
              method = 'glm', 
              method.args = list(family='binomial'),
              se = FALSE,
              color = text_color_red) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = 'none',
        title = element_text(color = text_color_red)) +
  scale_fill_brewer() +
  scale_alpha_manual(values = c(.1,.7)) +
  annotate(geom='text',x=-1.85,y=.76,
           label=TeX(paste0('$u_X=$',numform(ux1))),
           color=text_color_red) +
  annotate(geom='text',x=-1.85,y=.7,
           label=TeX(paste0('$u_Z=$',numform(uz1))),
           color=text_color_red) +
  th_red +
  labs(
    x = "X",
    y = "Probability of selection"
  )

h2u = ggplot(data=NULL,aes(x = x1,y=z1))  +
  geom_point(aes(alpha = Selected1),
    na.rm = TRUE, size = .8,fill=main_color_red,color=main_color_red) +
  coord_cartesian(expand = FALSE) +
  theme(legend.position = 'none',
        title = element_text(color = text_color_blue)) +
  scale_fill_brewer() +
  scale_alpha_manual(values = c(.15,.8)) +
  scale_x_continuous(limits = c(-3,3)) +
  scale_y_continuous(limits = c(-3,3)) +
  th_red +
  labs(
    title = TeX('Low correlation: $\\rho_{XZ}=$.20'),
    x = "X",
    y = "Z"
  )

(h2u + h1u) / (h2 + h1)

```

## Correcting Correlations for Indirect Range Restriction

### Defining our Target Quantity

We want to estimate the population correlation of the true scores of the independent variable ($T$) and dependent variable ($U$). We can denote this correlation as $\rho_{TU}$. Within a study sample that suffers from indirect selection (and sampling error), the study correlation is under selection ($r_{xy_S}$) will be biased relative to our target quantity, $\rho_{xy}$. This bias is captured by an artifact attenuation/inflation factor, $a$, such that,

$$
r_{XY} = a \rho_{XY|\mathcal{S}(Z)} + e 
$$

Therefore an unbiased estimate of the true score target population correlation can be estimated by dividing the observed score correlation under selection by an estimate of $a$,

$$
r_{TU} = \frac{ r_{XY|\mathcal{S}(Z)} }{ \hat{a}}.
$$

### Artifact Correction for Correlations

#### The Univariate Case {.unnumbered}

Range restriction (or enhancement) in either the independent or dependent variable will induce bias into the correlation coefficient. Let us consider a case where we select individuals based on meeting some criterion of some third variable, $Z$, such that $\mathcal{S}(Z)$. In the univariate case, we assume that selection on $Z$ only directly affects restriction/enhancement in $X$ while any restriction/enhancement in $Y$ is mediated by the effect on $X$ (see @fig-corr-model-uni).

Now consider a study where we want to calculate correlation in the target population between an independent variable, $X$, and a dependent variable, $Y$. However, the individual's are selected whether they are above the mean of $Z$ (Mean = 0). We can thus define the selection function such that,

$$
\mathcal{S}(Z) = \begin{cases} 1 & \text{if } Z \geq 0 \\ 0 & \text{if } Z < 0 \end{cases}
$$

In the following examples, we will simulate a correlation of $\rho_{XZ}=.80$.

![The assumed correlation structure of univariate indirect selection. The correlation between $Z$ and $Y$ is completely mediated by $X$ (i.e., the partial correlation between $Y$ and $Z$, controlling for $X$ is zero such that, $\rho_{YZ.X}=0$).](figure/indirect_select_corr_model_uni.png){#fig-corr-model-uni}

@fig-uvirr shows a $u$-ratio of about $u_X=0.75$ in the independent variable. We see that the sample correlation in the restricted scores ($r_{XY|\mathcal{S}(Z)}=.42$) is attenuated relative to the unrestricted correlation ($r_{XY}=.50$).

```{r, echo=FALSE,warning=FALSE,fig.height=5}
#| id: fig-uvirr
#| fig-cap: Scatterplot showing a correlation between $X$ and $Y$ under univariate indirect range restriction. Dark red dots indicate the selected sample and the transparent dots indicate the rejected sample.

set.seed(343)
data <- mvrnorm(n=2000,mu=c(0,0),
                Sigma = reshape_vec2mat(c(.5)),
                empirical=TRUE)

x = data[,1]
y = data[,2]
z = x + rnorm(2000,0,.75)
Selected <- z > 0

ggplot(data=NULL, aes(x = x, y = y, alpha=Selected)) +
  geom_vline(xintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_hline(yintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_point(stroke = 0, size = 1.65,color = main_color_red) + 
  guides(alpha = guide_legend(override.aes = list(size = 5)))+
  theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        title = element_text(color = text_color_red,size=17),
        panel.background = element_rect(fill = panel_color_red),
        panel.border = element_rect(fill = NA, 
                                    color = border_color_red,
                                    linewidth=1.2),
        axis.title = element_text(size=16, color = text_color_red),
        axis.text = element_text(size=14, color = text_color_red),
        axis.ticks = element_line(color = border_color_red,linewidth=1),
        legend.key = element_rect(fill='transparent'),
        legend.text = element_text(color=text_color_red,size=12)) +
  annotate(geom = 'text',x=-3,y=2.9,label=TeX('$\\rho_{XY}$ = .50'),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.5,
           label=TeX(paste0('$r_{XY|S(Z)}$ = ',numform(cor(x[Selected],y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.1,
           label=TeX(paste0('$\\u_{x}$ = ',numform(sd(x[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  scale_alpha_manual(values = c(.15,.8)) +
  ylim(-3,3) +
  xlim(-3,3) +
  xlab("X") +
  ylab("Y") +
  ggtitle('Univariate Range Restriction') 

```

We can also visualize what happens to the correlation when the range is enhanced. Enhancement can be accomplished by selecting individuals at the ends of the distribution [@taylor1976]. For indirect selection, individuals are selected at the ends of the distribution of $Z$ such that the selection function can be defined as,

$$
\mathcal{S}(Z) = \begin{cases} 1 & \text{if } Z \leq -1 \text{ or } Z \geq 1 \\ 0 & \text{if } Z < -1 \text{ or } Z >1 \end{cases}
$$

In @fig-uvire, we see an opposite effect on the correlation, that is, an inflation of the correlation rather than an attenuation like we see under range restriction. The scenario below has a $u$-ratio of about $u_X=1.32$ in the independent variable.

```{r, echo=FALSE,warning=FALSE,fig.height=5}
#| id: fig-uvire
#| fig-cap: Scatterplot showing a correlation between $X$ and $Y$ under univariate indirect range enhancement. Dark red dots indicate the selected sample and the transparent dots indicate the rejected sample.


Selected <- z < -1 | z > 1 

ggplot(data=NULL, aes(x = x, y = y, alpha=Selected)) +
  geom_vline(xintercept = 0, alpha=.1, linewidth = .8,color = main_color_blue) +
  geom_hline(yintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_point(stroke = 0, size = 1.65,color = main_color_red) + 
  guides(alpha = guide_legend(override.aes = list(size = 5)))+
  theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        title = element_text(color = text_color_red,size=17),
        panel.background = element_rect(fill = panel_color_red),
        panel.border = element_rect(fill = NA, color = border_color_red,linewidth=1.2),
        axis.title = element_text(size=16, color = text_color_red),
        axis.text = element_text(size=14, color = text_color_red),
        axis.ticks = element_line(color = border_color_red,linewidth=1),
        legend.key = element_rect(fill='transparent'),
        legend.text = element_text(color=text_color_red,size=12)) +
  annotate(geom = 'text',x=-3,y=2.9,label=TeX('$r_{XY}$ = .50'),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.5,
           label=TeX(paste0('$r_{XY|S(Z)}$ = ',numform(cor(x[Selected],y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.1,
           label=TeX(paste0('$\\u_{x}$ = ',numform(sd(x[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  scale_alpha_manual(values = c(.15,.8)) +
  ylim(-3,3) +
  xlim(-3,3) +
  xlab("x scores") +
  ylab("y scores") +
  ggtitle('Univariate Range Enhancement')


```

In summary, if $u_X>1$ (i.e., $S_{X|\mathcal{S}(Z)}>S_{X}$) the observed correlation is inflated relative to the correlation in the target population. Whereas the correlation is attenuated when $u_X<1$ [i.e., $S_{X|\mathcal{S}(Z)}<S_{X}$, @sackett2000]. An estimate of the attenuation/inflation factor, $\hat{a}$, can account for the bias in the observed correlation induced by range restriction/enhancement [equation 5, @le2006].

$$
\hat{a} = \sqrt{r_{XY|\mathcal{S}(Z)}^2 + u_{X}^2 (1- r_{XY|\mathcal{S}(Z)}^2)  }
$$ Using the estimated attenuation/inflation factor, we can correct the observed correlation for bias induced by indirect selection

$$
r_{XY} = \frac{r_{XY|\mathcal{S}(Z)}}{\hat{a}} = \frac{r_{XY|\mathcal{S}(Z)}}{\sqrt{r_{XY|\mathcal{S}(Z)}^2 + u_{X}^2 (1- r_{XY|\mathcal{S}(Z)}^2)  }}
$$ {#eq-univariate}

If we wants to correct for range restriction/enhancement *and* measurement error, we can incorporate the reliability coefficients (under selection) of $X$ ($r_{XX'|\mathcal{S}(Z)}$) and $Y$ ($r_{YY'|\mathcal{S}(Z)}$) into the formula for $\hat{a}$,

$$
\hat{a} = \sqrt{r_{XY|\mathcal{S}(Z)}^2 + \frac{u_{X}^2 r_{XX'|\mathcal{S}(Z)}\left(r_{XX'|\mathcal{S}(Z)}r_{YY'|\mathcal{S}(Z)} - r_{XY|\mathcal{S}(Z)}^2\right) }{1 - u_{X}^2 \left(1-r_{XX'|\mathcal{S}(Z)}\right)} }
$$

Now correcting the observed correlation with this modified estimate of $a$ to correct the observed correlation will yield the true score correlation in the target population,

$$
r_{TU}=\frac{r_{XY|\mathcal{S}(Z)}}{\hat{a}} = \frac{r_{XY|\mathcal{S}(Z)}}{\sqrt{r_{XY|\mathcal{S}(Z)}^2 + \frac{u_{X}^2 r_{XX'|\mathcal{S}(Z)}\left(r_{XX'|\mathcal{S}(Z)}r_{YY'|\mathcal{S}(Z)} - r_{XY|\mathcal{S}(Z)}^2\right) }{1 - u_{X}^2 \left(1-r_{XX'|\mathcal{S}(Z)}\right)} }}
$$

If the reliability coefficients come from the target population and do not suffer selection effects, we can estimate the reliability under selection using the following formulas [equation 11 and 12 @le2006]:

$$
r_{XX'|\mathcal{S}(Z)} = 1-\frac{1-r_{XX'}}{u_X^2}
$$ {#eq-rel-x}

$$
r_{YY'|\mathcal{S}(Z)} = 1-\frac{1-r_{YY'}}{u_Y^2}
$$ {#eq-rel-y}

We now need to adjust the standard error for the corrected correlation coefficient. To do this, we can either divide the observed standard error by the attenuation/inflation factor (or equivalently, the observed correlation divided by the corrected correlation),

$$
se(r_{TU}) = \frac{se\left(r_{XY|\mathcal{S}(Z)}\right)}{\hat{a}}= \frac{se\left(r_{XY|\mathcal{S}(Z)}\right)}{\left[\frac{r_{XY|\mathcal{S}(Z)}}{r_{TU}}\right]}.
$$



::: {.callout-note appearance="default" icon="false"}
## Applied Example in R

Let's say a university admits students based on some criterion upon a composite of multiple measures of performance ($Z$). One of those measures is a standardized test ($X$). A researcher then wants to see how test performance predicts stress ($Y$) in college. Since test performance is correlated with the composite used in the college admissions process, it is likely that we will observe substantial range restriction in the college sample. To index this restriction in range, we calculate the $u$-ratio of test scores as $u_{X}=0.70$ (relative to the total pool of applicants). We also want to correct for measurement error in test performance and the self-report questionnaire we use to measure stress, therefore we obtain reliability estimates within our sample of $r_{XX'|\mathcal{S}(Z)}=.90$ and $r_{XX'|\mathcal{S}(Z)}=.80$, respectively. The researcher then conducts the study and finds a sample correlation of $r_{XY|\mathcal{S}(Z)}=.25$, but he wants to know that true score correlation. 

In R, we can correct the correlation by using the `correct_r` function in the `psychmeta` package [@dahlke2019]. The `correction = 'uvirr_x'`

```{r,message=FALSE}
library(psychmeta)

correct_r(correction = 'uvirr_x',
          rxyi = .25,  # restricted correlation
          rxx = .90,  # reliability of test scores
          ryy = .80,  # reliability of stress
          ux = .70,   # u ratio of SAT scores
          n = 100)    # sample size
```

The true score correlation in the target population is estimated to be $r_{TU} = .41\, [.10,\, .65]$.
:::



#### The Bivariate Case {.unnumbered}

Bivariate indirect range restriction/enhancement occurs when the selection variable has independent relationships with both the independent and dependent variable. Like we did for the univariate case, let's visualize the correlation between independent ($X$) and dependent ($Y$) variables under range restriction by only selecting individuals above a score of -0.50 in our selector variable, $Z$. Therefore the selection function can be defined as,

$$
\mathcal{S}(Z)=\begin{cases} 1 &\text{ if } Z \geq-.50 \\  0 &\text{ if } Z <-.50  \end{cases}
$$

We will also fix the correlations between the selector and independent variable ($\rho_{XZ}$), as well as the selector and dependent variable ($\rho_{YZ}$) to be .80. Unlike the univariate case, in the bivariate case $X$ *and* $Y$ have direct relationships with $Z$ (see @fig-corr-model-biv).

![The assumed correlation structure of univariate indirect selection. The correlation between $Z$ and $Y$ is completely mediated by $X$ (i.e., the partial correlation between $Y$ and $Z$, controlling for $X$ is zero such that, $\rho_{YZ.X}=0$).](figure/indirect_select_corr_model_biv.png){#fig-corr-model-biv}


The scenario displayed in @fig-bvirr, shows a $u$-ratio of about $u_X=u_Y=0.81$ in the independent variable and dependent variables. We see in the figure below that the correlation in the restricted sample ($\rho_{XY|\mathcal{S}(Z)}=.25$) is attenuated relative to the target population correlation ($\rho_{XY}=.50$).

```{r, echo=FALSE,warning=FALSE,fig.height=5}
#| id: fig-bvirr
#| fig-cap: Scatterplot showing a correlation between $X$ and $Y$ under bivariate indirect range restriction. Dark red dots indicate the selected sample and the transparent dots indicate the rejected sample.

set.seed(1)

data <- mvrnorm(n=2000,
                mu=c(0,0,0),
                Sigma = reshape_vec2mat(c(.5,.8,.8)),
                empirical=TRUE)

x = data[,1]
y = data[,2]
z = data[,3]

Selected <- z > -.5

ggplot(data=NULL, aes(x = x, y = y, alpha=Selected)) +
  geom_vline(xintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_hline(yintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_point(stroke = 0, size = 1.65,color = main_color_red) + 
  guides(alpha = guide_legend(override.aes = list(size = 5)))+
  theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        title = element_text(color = text_color_red,size=17),
        panel.background = element_rect(fill = panel_color_red),
        panel.border = element_rect(fill = NA, color = border_color_red,linewidth=1.2),
        axis.title = element_text(size=16, color = text_color_red),
        axis.text = element_text(size=14, color = text_color_red),
        axis.ticks = element_line(color = border_color_red,linewidth=1),
        legend.key = element_rect(fill='transparent'),
        legend.text = element_text(color=text_color_red,size=12)) +
  annotate(geom = 'text',x=-3,y=2.9,label=TeX('$r_{XY}$ = .50'),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.5,
           label=TeX(paste0('$r_{XY|S(Z)}$ = ',numform(cor(x[Selected],y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.1,
           label=TeX(paste0('$\\u_{X}$ = ',numform(sd(x[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=1.7,
           label=TeX(paste0('$\\u_{Y}$ = ',numform(sd(y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  scale_alpha_manual(values = c(.15,.8)) +
  ylim(-3,3) +
  xlim(-3,3) +
  xlab("X") +
  ylab("Y") +
  ggtitle('Bivariate Range Restriction') 
```

Likewise let's visualize what happens to the correlation when the range is enhanced. Enhancement in both variables can be accomplished by selecting individuals at the ends of the distribution of $Z$ (for this case we will select individuals below a score of -1 and above a score of 1). We can thus define the selection function as,

$$
\mathcal{S}(Z)=\begin{cases} 1 &\text{ if } Z \leq-1 \text{ or } Z \geq 1  \\  0 &\text{ if } Z > -1  \text{ or } Z < 1   \end{cases}
$$


In @fig-bvire, we observe an inflation of observed correlation ($\rho_{XY|\mathcal{S}(Z)}=.74$) relative to the target correlation ($\rho_{XY}=.50$). @fig-bvire has a $u$-ratio of about $u_X=u_Y=1.38$ in both the independent variable and dependent variable.

```{r, echo=FALSE,warning=FALSE,fig.height=5}
#| id: fig-bvire
#| fig-cap: Scatterplot showing a correlation between $X$ and $Y$ under bivariate indirect range enhancement. Dark red dots indicate the selected sample and the transparent dots indicate the rejected sample.


Selected <- ( z < -1 | z > 1 )

ggplot(data=NULL, aes(x = x, y = y, alpha=Selected)) +
  geom_vline(xintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_hline(yintercept = 0, alpha=.1, linewidth = .8,color = main_color_red) +
  geom_point(stroke = 0, size = 1.65,color = main_color_red) + 
  guides(alpha = guide_legend(override.aes = list(size = 5)))+
  theme(aspect.ratio = 1,
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        title = element_text(color = text_color_red,size=17),
        panel.background = element_rect(fill = panel_color_red),
        panel.border = element_rect(fill = NA, color = border_color_red,linewidth=1.2),
        axis.title = element_text(size=16, color = text_color_red),
        axis.text = element_text(size=14, color = text_color_red),
        axis.ticks = element_line(color = border_color_red,linewidth=1),
        legend.key = element_rect(fill='transparent'),
        legend.text = element_text(color=text_color_red,size=12)) +
  annotate(geom = 'text',x=-3,y=2.9,label=TeX('$r_{XY}$ = .50'),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.5,
           label=TeX(paste0('$r_{XY|S(Z)}$ = ',numform(cor(x[Selected],y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=2.1,
           label=TeX(paste0('$\\u_{X}$ = ',numform(sd(x[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  annotate(geom = 'text',x=-3,y=1.7,
           label=TeX(paste0('$\\u_{Y}$ = ',numform(sd(y[Selected])))),
           color = text_color_red, size = 5, hjust='left') + 
  scale_alpha_manual(values = c(.15,.8)) +
  ylim(-3,3) +
  xlim(-3,3) +
  xlab("x scores") +
  ylab("y scores") +
  ggtitle('Bivariate Range Enhancement')
```

A bias correction formula for bivariate range restriction is much more complicated than the univariate formulation. In the univariate case, we did not need any more information about the selection process beyond what we could infer from $u_X$. However in the bivariate case, we need to have a basic idea of the selection mechanism at play [@dahlke2020]. Particularly we at least know the direction of the correlation between the selector variable, $Z$, and the independent ($\rho_{XZ}$) and dependent variable ($\rho_{YZ}$). This will require a little bit of knowledge about the selection process within a given study. Let us first define a factor we will denote with $\lambda$ [@dahlke2020]. This factor takes into account the direction of the correlation of $\rho_{XZ}$ (if positive, we can set $\rho_{XZ}=1$, if negative, $\rho_{XZ}=-1$, if zero, $\rho_{XZ}=0$) and $\rho_{YZ}$ (repeat the same procedure as $\rho_{XZ}$). Therefore $\lambda$ can be defined as,

$$\begin{aligned}
\lambda =& \text{ sign}\left(\rho_{XZ}\rho_{YZ} [1-u_X][1-u_Y]\right)\times \\[.3em] &\frac{\text{sign}
\left(1-u_X\right)\min\left(u_X,\frac{1}{u_X}\right) + 
\text{ sign}\left(1-u_Y\right)\min\left(u_Y,\frac{1}{u_Y}\right)
}{\min\left(u_X,\frac{1}{u_X}\right)+\min\left(u_Y,\frac{1}{u_Y}\right)}.
\end{aligned}$$

Although complex, the output of $\lambda$ will be either -1, 0, or 1. We can then plug this factor into the full correction equation that provides us with an unbiased estimate of the correlation in the unrestricted population,

$$
r_{XY} = r_{XY|\mathcal{S}(Z)}u_Xu_Y+\lambda\sqrt{|1-u_X^2||1-u_Y^2|}
$$

Similar to the univariate formula, we can also incorporate measurement error into the correction. Measurement error will bias the correlation on top of the bias induced by range restriction/enhancement. Therefore we can incorporate the reliabilities estimated within the restricted sample ($r_{XX'|\mathcal{S}(Z)}$ and $r_{YY'|\mathcal{S}(Z)}$), into our correction formula:

$$
r_{TU} = \frac{r_{XY|\mathcal{S}(Z)}u_Xu_Y+\lambda\sqrt{|1-u_X^2||1-u_Y^2|}}{\sqrt{1-u_X^2\left(1-r_{XX'|\mathcal{S}(Z)}\right)}\sqrt{1-u_Y^2\left(1-r_{YY'|\mathcal{S}(Z)}\right)}}
$$

If the reliability estimates come from an target population reference sample, we can get estimates of the reliability coefficients in the selected sample using @eq-rel-x and @eq-rel-y. We then can correct the observed sampling variance ($\sigma^2_{\varepsilon_o}$),


$$
se(r_{TU}) = \frac{se\left(r_{XY|\mathcal{S}(Z)}\right)}{\hat{a}}= \frac{se\left(r_{XY|\mathcal{S}(Z)}\right)}{\left[\frac{r_{XY|\mathcal{S}(Z)}}{r_{TU}}\right]}.
$$


::: {.callout-note appearance="default" icon="false"}
## Applied Example in R

Continuing with the example from the univariate case, a university admits applicants based on some criterion upon a composite of multiple measures of performance ($Z$). Two of those measures is a standardized test ($X$) and high school grade-point average (GPA). A researcher then wants to see how test performance predicts college GPA ($Y$). Since *both* test performance is correlated with the composite used in the college admissions process, it is likely that we will observe substantial range restriction in the college sample. The $u$-ratio in test performance and GPA was $u_{X}=u_{Y}=0.80$ (applicants are the target population). We also want to correct for measurement error in the dependent variable (grade-point average) only we use to measure stress, therefore we obtain a reliability estimate within our sample of $r_{YY'|\mathcal{S}(Z)}=.90$. The researcher then conducts the study and finds a sample correlation of $r_{XY|\mathcal{S}(Z)}=.25$.

In R, we can correct the correlation by using the `correct_r` function in the `psychmeta` package [@dahlke2019]. The `correction = 'uvirr_x'`

```{r,message=FALSE}
library(psychmeta)

correct_r(correction = 'uvirr_x',
          rxyi = .25,  # restricted correlation
          ryy = .90,  # reliability of GPA
          ux = .80,   # u ratio of SAT scores
          n = 100)    # sample size
```

The true score correlation in the target population is estimated to be $r_{TU} = .32\, [.07,\, .53]$.
:::



## Beware of assumptions {.unnumbered}

Note that these corrections require the following assumptions: 1) linearity between $X$ and $Y$, 2) homoskedasticity, that is, equal variance in $Y$ at every level of $X$.




```{=html}
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="matthewbjane" data-description="Support me on Buy me a coffee!" data-message="Thank you for being here! Consider buying me a coffee!" data-color="#eeb4d7ff" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
```
